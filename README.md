[![CI](https://github.com/vturrojas/authz-service/actions/workflows/tests.yml/badge.svg?branch=main&v=1)](https://github.com/vturrojas/authz-service/actions/workflows/tests.yml)

# AuthZ Service (Policy-Driven Authorization)

A small backend service that makes deterministic authorization decisions from
explicit inputs (subject, action, resource, context) and records an auditable
decision trail.

This project is intentionally **not** an IAM platform.

---

## Purpose

Authorization is treated as a first-class backend domain:

- Explicit, structured decision inputs
- Deny-by-default semantics
- Policy evaluation separated from enforcement
- Deterministic, auditable decisions

The goal is to demonstrate clear backend decision logic in a security-sensitive
domain without building a full identity or access management system.

---

## Non-goals

- Not an identity system (no users, orgs, groups, SCIM)
- Not an authentication system (no login, MFA, sessions, SSO)
- Not a token authority or identity provider
- Not a general-purpose policy language or DSL
- Not an enterprise IAM product
- Not a security marketing exercise

**Rule of thumb:**  
If a feature models people or organizations more than authorization decisions,
it is out of scope.

---

## API (v0)

**POST /v1/authorize**

**Inputs**
- `subject`
- `action`
- `resource`
- `context`

**Outputs**
- `decision` (`allow` | `deny`)
- `reason`
- `decision_id`
- `policy_id`
- `policy_version`
- `matched_rule_ids`

This service produces decisions only.  
Enforcement is intentionally left to downstream services.

---

## Policy model

- Ordered rules
- Effects: `allow`, `deny`
- Default: deny
- Explicit deny overrides allow
- Policies are defined as JSON
- Schema is strict (`extra=forbid`)
- Policy parsing converts DTOs → domain models
- Active policy is loaded from `AUTHZ_POLICY_PATH`
- Reload uses file `mtime` checks (no file watchers)
- Single active policy by design (v0)

---

## Evaluation semantics

- Deterministic
- Deny-by-default
- Same inputs + same policy → same decision

No caching is applied in the initial implementation.

---

## Audit trail

Each authorization decision produces an append-only audit record including:

- decision and reason
- subject, action, resource
- policy id and version
- correlation id
- timestamp (UTC)

Auditing is opt-in via configuration and is treated as a correctness requirement,
not a best-effort side effect.

---

## Tradeoffs

- Correctness favored over latency
- Simplicity favored over expressiveness
- Operator clarity favored over feature completeness

Several production concerns (caching, persistence, policy authoring) are
deliberately deferred.

---

## Project layout

```
backend/src/app/domain    # Pure authorization logic
backend/src/app/api       # HTTP routes and middleware
backend/src/app/services  # Orchestration and I/O boundaries
backend/tests             # Tests
policies/                 # Example policies
scripts/                  # Developer utilities
```

---

## Operational conventions

- Correlation ID: `X-Correlation-Id`
  - Accepted from clients or generated by the service
  - Echoed on all responses
  - Included in audit records and error responses

- Error shape:
```json
{
  "error": {
    "code": "...",
    "message": "...",
    "details": { ... },
    "correlation_id": "..."
  }
}
```

- Audit behavior:
  - Disabled unless explicitly configured
  - If enabled and an audit write fails, the request fails (no silent loss)

---

## Quick smoke test

1. Start the service:

```bash
cd backend
export AUTHZ_POLICY_PATH=../policies/sample_policy.json
export AUTHZ_AUDIT_PATH=../audit.jsonl
fastapi dev app/main.py
```

2. Run the smoke test:

```bash
./scripts/smoke.sh
```

The smoke script exercises both allow and deny paths and verifies audit output.

---

## Status

This project is intentionally modest in scope and incomplete by design.
It exists to demonstrate engineering judgment, correctness, and clarity
in a backend authorization domain.
